<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3D NPC MVP</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100%;
      background: #000;
      font-family: system-ui, sans-serif;
      color: #fff;
    }
    #overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.8);
      cursor: pointer;
      z-index: 10;
    }
    #overlay button {
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
    }
    #hint {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.6);
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 13px;
      pointer-events: none;
    }
    #chatBox {
      position: fixed;
      right: 16px;
      bottom: 16px;
      width: 260px;
      max-height: 40%;
      background: rgba(0, 0, 0, 0.8);
      border: 1px solid #444;
      border-radius: 6px;
      display: none;
      flex-direction: column;
      z-index: 20;
    }
    #chatMessages {
      flex: 1;
      padding: 8px;
      overflow-y: auto;
      font-size: 12px;
    }
    #chatInputContainer {
      border-top: 1px solid #444;
      display: flex;
    }
    #chatInput {
      flex: 1;
      padding: 6px;
      border: none;
      outline: none;
      font-size: 12px;
    }
    #chatSend {
      padding: 6px 10px;
      border: none;
      background: #4caf50;
      color: #fff;
      cursor: pointer;
      font-size: 12px;
    }
  </style>
</head>

<body>

  <!-- Three.js from CDN FIRST -->
  <script src="https://unpkg.com/three@0.161.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.161.0/examples/js/controls/PointerLockControls.js"></script>

  <div id="overlay">
    <button>Click to enter the world</button>
  </div>

  <div id="hint">WASD to move • Mouse to look • Go near the cube and press E to talk</div>

  <div id="chatBox">
    <div id="chatMessages"></div>
    <div id="chatInputContainer">
      <input id="chatInput" type="text" placeholder="Say something..." />
      <button id="chatSend">Send</button>
    </div>
  </div>

  <script>
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x222222);

    const camera = new THREE.PerspectiveCamera(
      75,
      window.innerWidth / window.innerHeight,
      0.1,
      1000
    );
    camera.position.set(0, 1.8, 5);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
    scene.add(hemiLight);

    const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
    dirLight.position.set(5, 10, 7.5);
    scene.add(dirLight);

    const floorGeo = new THREE.PlaneGeometry(100, 100);
    const floorMat = new THREE.MeshStandardMaterial({ color: 0x555555 });
    const floor = new THREE.Mesh(floorGeo, floorMat);
    floor.rotation.x = -Math.PI / 2;
    scene.add(floor);

    const npcGeo = new THREE.BoxGeometry(1, 2, 1);
    const npcMat = new THREE.MeshStandardMaterial({ color: 0x2196f3 });
    const npc = new THREE.Mesh(npcGeo, npcMat);
    npc.position.set(0, 1, -5);
    scene.add(npc);

    const controls = new THREE.PointerLockControls(camera, document.body);
    const overlay = document.getElementById("overlay");

    overlay.addEventListener("click", () => {
      controls.lock();
    });

    controls.addEventListener("lock", () => {
      overlay.style.display = "none";
    });

    controls.addEventListener("unlock", () => {
      overlay.style.display = "flex";
    });

    const keys = { KeyW:false, KeyA:false, KeyS:false, KeyD:false };

    document.addEventListener("keydown", e => {
      if (keys.hasOwnProperty(e.code)) keys[e.code] = true;
      if (e.code === "KeyE") tryInteract();
    });

    document.addEventListener("keyup", e => {
      if (keys.hasOwnProperty(e.code)) keys[e.code] = false;
    });

    let prevTime = performance.now();
    const velocity = new THREE.Vector3();
    const direction = new THREE.Vector3();

    function updateMovement() {
      const time = performance.now();
      const delta = (time - prevTime) / 1000;
      prevTime = time;
      if (!controls.isLocked) return;

      velocity.x -= velocity.x * 10 * delta;
      velocity.z -= velocity.z * 10 * delta;

      direction.z = Number(keys.KeyS) - Number(keys.KeyW);
      direction.x = Number(keys.KeyD) - Number(keys.KeyA);
      direction.normalize();

      const speed = 5;
      if (keys.KeyW || keys.KeyS) velocity.z -= direction.z * speed * delta;
      if (keys.KeyA || keys.KeyD) velocity.x -= direction.x * speed * delta;

      controls.moveRight(-velocity.x * delta);
      controls.moveForward(-velocity.z * delta);

      controls.getObject().position.y = 1.8;
    }

    const chatBox = document.getElementById('chatBox');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const chatSend = document.getElementById('chatSend');

    function addMessage(from, text) {
      const div = document.createElement('div');
      div.textContent = from + ': ' + text;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function npcReply() {
      const replies = [
        "Interesting. Why?",
        "I'm just a cube but I care.",
        "What a strange world we live in.",
        "Explain more.",
        "Deep thoughts."
      ];
      return replies[Math.floor(Math.random() * replies.length)];
    }

    function sendMessage() {
      const text = chatInput.value.trim();
      if (!text) return;
      addMessage("You", text);
      chatInput.value = "";
      setTimeout(() => addMessage("NPC", npcReply()), 500);
    }

    chatSend.addEventListener('click', sendMessage);
    chatInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') sendMessage();
    });

    function tryInteract() {
      const camPos = controls.getObject().position.clone();
      const npcPos = npc.position.clone();
      if (camPos.distanceTo(npcPos) < 3) {
        chatBox.style.display = "flex";
        chatInput.focus();
      }
    }

    function animate() {
      requestAnimationFrame(animate);
      updateMovement();
      renderer.render(scene, camera);
    }
    animate();

    window.addEventListener("resize", () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>

</body>
</html>
